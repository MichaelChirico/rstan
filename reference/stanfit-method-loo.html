<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Approximate leave-one-out cross-validation — loo.stanfit • rstan</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Approximate leave-one-out cross-validation — loo.stanfit"><meta property="og:description" content="A loo method that is customized for stanfit objects.
The loo method for stanfit objects ---a wrapper around the array
method for loo in the  loo package --- computes PSIS-LOO CV,
approximate leave-one-out cross-validation using Pareto smoothed importance
sampling (Vehtari, Gelman, and Gabry, 2017a,2017b)."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rstan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.26.24</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="https://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="https://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/loo" class="external-link">loo</a>
    </li>
    <li>
      <a href="https://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstantools">rstantools</a>
    </li>
  </ul></li>
<li>
  <a href="https://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/rstan" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Approximate leave-one-out cross-validation</h1>
    
    <div class="hidden name"><code>stanfit-method-loo.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>A <code><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></code> method that is customized for stanfit objects.
The <code>loo</code> method for stanfit objects ---a wrapper around the <code>array</code>
method for <code><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></code> in the  <span class="pkg">loo</span> package --- computes PSIS-LOO CV,
approximate leave-one-out cross-validation using Pareto smoothed importance
sampling (Vehtari, Gelman, and Gabry, 2017a,2017b).</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># S3 method for stanfit</span></span>
<span><span class="fu">loo</span><span class="op">(</span><span class="va">x</span>,</span>
<span>    pars <span class="op">=</span> <span class="st">"log_lik"</span>,</span>
<span>    save_psis <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    cores <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">getOption</a></span><span class="op">(</span><span class="st">"mc.cores"</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    moment_match <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    k_threshold <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span>    <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>x</dt>
<dd><p>An object of S4 class <code>stanfit</code>.</p></dd>

  <dt>pars</dt>
<dd><p>Name of transformed parameter or generated quantity in
  the Stan program corresponding to the pointwise log-likelihood. If not
  specified the default behavior is to look for <code>"log_lik"</code>.</p></dd>

  <dt>save_psis</dt>
<dd><p>Should the intermediate results from <code><a href="https://mc-stan.org/loo/reference/psis.html" class="external-link">psis</a></code>
  be saved in the returned object? The default is <code>FALSE</code>. This can be
  useful to avoid repeated computation when using other functions in the
  <span class="pkg">loo</span> and <span class="pkg">bayesplot</span> packages.</p></dd>

  <dt>cores</dt>
<dd><p>Number of cores to use for parallelization. The default is 1 unless
  <code>cores</code> is specified or the <code>mc.cores</code> <a href="https://rdrr.io/r/base/options.html" class="external-link">option</a>
  has been set.</p></dd>

<dt>moment_match</dt>
<dd><p>Logical; Whether to use the moment matching algorithm for
  observations with high Pareto k values to improve accuracy. Note:
  because the moment matching algorithm relies on the <code>unconstrain_pars</code>
  method in RStan it is only available if run in the same R session as fitting the
  model.</p></dd>

  <dt>k_threshold</dt>
<dd><p>Threshold value for Pareto k values above which
  the moment matching algorithm is used. If <code>moment_match</code> is <code>FALSE</code>,
  this is ignored.</p></dd>

  <dt>...</dt>
<dd><p>Ignored.</p></dd>

</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>Stan does not automatically compute and store the log-likelihood. It
  is up to the user to incorporate it into the Stan program if it is to be
  extracted after fitting the model. In a Stan program, the pointwise log
  likelihood can be coded as a vector in the transformed parameters block
  (and then summed up in the model block) or it can be coded entirely in the
  generated quantities block. We recommend using the generated quantities
  block so that the computations are carried out only once per iteration
  rather than once per HMC leapfrog step.</p>
<p>For example, the following is the <code>generated quantities</code> block for
  computing and saving the log-likelihood for a linear regression model with
  <code>N</code> data points, outcome <code>y</code>, predictor matrix <code>X</code> (including
  column of 1s for intercept), coefficients <code>beta</code>,
  and standard deviation <code>sigma</code>:</p>
<p><code>vector[N] log_lik;</code></p>
<p><code>for (n in 1:N) log_lik[n] = normal_lpdf(y[n] | X[n, ] * beta, sigma);</code></p>
<p>This function automatically uses Pareto k diagnostics for assessing
  the accuracy of importance sampling for each observation. When the
  diagnostics indicate that importance sampling for certain observations
  is inaccurate, a moment matching algorithm can be used, which can
  improve the accuracy (Paananen et al., 2020).</p>
    </div>
    <div id="value">
    <h2>Value</h2>
    

<p>A list with class <code>c("psis_loo", "loo")</code>, as detailed in the</p>
<p></p>
<p><code><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></code> documentation.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>Vehtari, A., Gelman, A., and Gabry, J. (2017a).
Practical Bayesian model evaluation using leave-one-out cross-validation and WAIC.
<em>Statistics and Computing</em>. 27(5), 1413-1432.
<code>doi:10.1007/s11222-016-9696-4</code>.
<a href="https://arxiv.org/abs/1507.04544" class="external-link">https://arxiv.org/abs/1507.04544</a>,
<a href="https://link.springer.com/article/10.1007/s11222-016-9696-4" class="external-link">https://link.springer.com/article/10.1007/s11222-016-9696-4</a></p>
<p>Vehtari, A., Gelman, A., and Gabry, J. (2017b).
Pareto smoothed importance sampling. arXiv preprint:
<a href="https://arxiv.org/abs/1507.02646" class="external-link">https://arxiv.org/abs/1507.02646</a></p>
<p>Yao, Y., Vehtari, A., Simpson, D., and Gelman, A. (2018).
Using stacking to average Bayesian predictive distributions.
Bayesian Analysis, advance publication, <code>doi:10.1214/17-BA1091</code>.</p>
<p>Paananen, T., Piironen, J., Buerkner, P.-C., Vehtari, A. (2020).
Implicitly Adaptive Importance Sampling.
arXiv preprint:
<a href="https://arxiv.org/abs/1906.08850" class="external-link">https://arxiv.org/abs/1906.08850</a>.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p></p><ul><li><p>The <span class="pkg"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span> package documentation, including the vignettes for
 many examples (<a href="https://mc-stan.org/loo/" class="external-link">https://mc-stan.org/loo/</a>).</p></li>
<li><p><code><a href="https://mc-stan.org/loo/reference/loo_moment_match.html" class="external-link">loo_moment_match</a></code> for the moment matching algorithm.</p></li>
<li><p><code><a href="https://mc-stan.org/loo/reference/loo_model_weights.html" class="external-link">loo_model_weights</a></code> for model averaging/weighting via
 stacking or pseudo-BMA weighting.</p></li>
</ul></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co"># Generate a dataset from N(0,1)</span></span></span>
<span class="r-in"><span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">100</span></span></span>
<span class="r-in"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Suppose we have three models for y:</span></span></span>
<span class="r-in"><span><span class="co">#  1) y ~ N(-1, sigma)</span></span></span>
<span class="r-in"><span><span class="co">#  2) y ~ N(0.5, sigma)</span></span></span>
<span class="r-in"><span><span class="co">#  3) y ~ N(0.6,sigma)</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="va">stan_code</span> <span class="op">&lt;-</span> <span class="st">"</span></span></span>
<span class="r-in"><span><span class="st">data {</span></span></span>
<span class="r-in"><span><span class="st">  int N;</span></span></span>
<span class="r-in"><span><span class="st">  vector[N] y;</span></span></span>
<span class="r-in"><span><span class="st">  real mu_fixed;</span></span></span>
<span class="r-in"><span><span class="st">}</span></span></span>
<span class="r-in"><span><span class="st">  parameters {</span></span></span>
<span class="r-in"><span><span class="st">  real&lt;lower=0&gt; sigma;</span></span></span>
<span class="r-in"><span><span class="st">}</span></span></span>
<span class="r-in"><span><span class="st">model {</span></span></span>
<span class="r-in"><span><span class="st">  sigma ~ exponential(1);</span></span></span>
<span class="r-in"><span><span class="st">  y ~ normal(mu_fixed, sigma);</span></span></span>
<span class="r-in"><span><span class="st">}</span></span></span>
<span class="r-in"><span><span class="st">generated quantities {</span></span></span>
<span class="r-in"><span><span class="st">  vector[N] log_lik;</span></span></span>
<span class="r-in"><span><span class="st">  for (n in 1:N) log_lik[n] = normal_lpdf(y[n]| mu_fixed, sigma);</span></span></span>
<span class="r-in"><span><span class="st">}"</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="stan_model.html">stan_model</a></span><span class="op">(</span>model_code <span class="op">=</span> <span class="va">stan_code</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="stanmodel-method-sampling.html">sampling</a></span><span class="op">(</span><span class="va">mod</span>, data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N<span class="op">=</span><span class="va">N</span>, y<span class="op">=</span><span class="va">y</span>, mu_fixed<span class="op">=</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="stanmodel-method-sampling.html">sampling</a></span><span class="op">(</span><span class="va">mod</span>, data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N<span class="op">=</span><span class="va">N</span>, y<span class="op">=</span><span class="va">y</span>, mu_fixed<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit3</span> <span class="op">&lt;-</span> <span class="fu"><a href="stanmodel-method-sampling.html">sampling</a></span><span class="op">(</span><span class="va">mod</span>, data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>N<span class="op">=</span><span class="va">N</span>, y<span class="op">=</span><span class="va">y</span>, mu_fixed<span class="op">=</span><span class="fl">0.6</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># use the loo method for stanfit objects</span></span></span>
<span class="r-in"><span><span class="va">loo1</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="op">(</span><span class="va">fit1</span>, pars <span class="op">=</span> <span class="st">"log_lik"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo1</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># which is equivalent to</span></span></span>
<span class="r-in"><span><span class="va">LL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">as.array</a></span><span class="op">(</span><span class="va">fit1</span>, pars <span class="op">=</span> <span class="st">"log_lik"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">r_eff</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/relative_eff.html" class="external-link">relative_eff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">LL</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">loo1b</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo.array</a></span><span class="op">(</span><span class="va">LL</span>, r_eff <span class="op">=</span> <span class="va">r_eff</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo1b</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># compute loo for the other models</span></span></span>
<span class="r-in"><span><span class="va">loo2</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">loo3</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="op">(</span><span class="va">fit3</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># stacking weights</span></span></span>
<span class="r-in"><span><span class="va">wts</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_model_weights.html" class="external-link">loo_model_weights</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">loo1</span>, <span class="va">loo2</span>, <span class="va">loo3</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"stacking"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">wts</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># use the moment matching for loo with a stanfit object</span></span></span>
<span class="r-in"><span><span class="va">loo_mm</span> <span class="op">&lt;-</span> <span class="fu">loo</span><span class="op">(</span><span class="va">fit1</span>, pars <span class="op">=</span> <span class="st">"log_lik"</span>, moment_match <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">loo_mm</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Jiqiang Guo, Jonah Gabry, Ben Goodrich, Andrew Johnson, Sebastian Weber.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

