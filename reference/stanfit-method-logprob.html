<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>log_prob and grad_log_prob functions — log_prob-methods • rstan</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="log_prob and grad_log_prob functions — log_prob-methods"><meta property="og:description" content="Using model's log_prob and grad_log_prob take values from the
  unconstrained space of model parameters and (by default) return values in 
  the same space. Sometimes we need to convert the values of parameters from 
  their support defined in the parameters block (which might be constrained, 
  and for simplicity, we call it the constrained space) to the unconstrained 
  space and vice versa. The constrain_pars and unconstrain_pars 
  functions are used for this purpose."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rstan</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.26.24</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="https://mc-stan.org/rstanarm">rstanarm</a>
    </li>
    <li>
      <a href="https://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="https://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="https://mc-stan.org/loo" class="external-link">loo</a>
    </li>
    <li>
      <a href="https://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="https://mc-stan.org/rstantools">rstantools</a>
    </li>
  </ul></li>
<li>
  <a href="https://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/stan-dev/rstan" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="https://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1><code>log_prob</code> and <code>grad_log_prob</code> functions</h1>
    
    <div class="hidden name"><code>stanfit-method-logprob.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Using model's <code>log_prob</code> and <code>grad_log_prob</code> take values from the
  unconstrained space of model parameters and (by default) return values in 
  the same space. Sometimes we need to convert the values of parameters from 
  their support defined in the parameters block (which might be constrained, 
  and for simplicity, we call it the constrained space) to the unconstrained 
  space and vice versa. The <code>constrain_pars</code> and <code>unconstrain_pars</code> 
  functions are used for this purpose.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre><code>&lt;!-- %% log_prob(object, upars, adjust_transform = TRUE, gradient = FALSE)  --&gt;
  # S4 method for stanfit
log_prob(object, upars, adjust_transform = TRUE, gradient = FALSE)
  &lt;!-- %% grad_log_prob(object, upars, adjust_transform = TRUE)  --&gt;
  # S4 method for stanfit
grad_log_prob(object, upars, adjust_transform = TRUE)
  &lt;!-- %% get_num_upars(object) --&gt;
  # S4 method for stanfit
get_num_upars(object)
  &lt;!-- %% constrain_pars(object, upars) --&gt;
  # S4 method for stanfit
constrain_pars(object, upars)
  &lt;!-- %% unconstrain_pars(object, pars) --&gt;
  # S4 method for stanfit
unconstrain_pars(object, pars)</code></pre></div>
    </div>

    <div id="methods">
    <h2>Methods</h2>
    <p></p><dl><dt>log_prob</dt>
<dd><p><code>signature(object = "stanfit")</code></p></dd>

      Compute <code>lp__</code>, the log posterior (up to an additive constant)
      for the model represented by a <code>stanfit</code> object. Note that,
      by default, <code>log_prob</code> returns the log posterior in the 
      <em>unconstrained</em> space Stan works in internally.
      set <code>adjust_transform = FALSE</code> to make the values match Stan's output.
    
    <dt>grad_log_prob</dt>
<dd><p><code>signature(object = "stanfit")</code></p></dd>
Compute the gradients
      for <code>log_prob</code> as well as the log posterior. The latter is returned as 
      an attribute. 
    
    <dt>get_num_upars</dt>
<dd><p><code>signature(object = "stanfit")</code></p></dd>
Get the number
      of unconstrained parameters.
     
    <dt>constrain_pars</dt>
<dd><p><code>signature(object = "stanfit")</code></p></dd>
Convert values
      of the parameter from unconstrained space (given as a vector) to their
      constrained space (returned as a named list).
    <dt>unconstrain_pars</dt>
<dd><p><code>signature(object = "stanfit")</code></p></dd>
Contrary to
      <code>constrained</code>, conert values of the parameters from constrained
      to unconstrained space.
    
  
</dl></div>
    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>object</dt>
<dd><p>An object of class <code><a href="stanfit-class.html">stanfit</a></code>.</p></dd>

  <dt>pars</dt>
<dd><p>An list specifying the values for all parameters on the
    constrained space.</p></dd>
 
  <dt>upars</dt>
<dd><p>A numeric vector for specifying the values for all parameters 
    on the unconstrained space.</p></dd>
  
  <dt>adjust_transform</dt>
<dd><p>Logical to indicate whether to adjust
    the log density since Stan transforms parameters to unconstrained
    space if it is in constrained space. Set to <code>FALSE</code> to make the
    function return the same values as Stan's <code>lp__</code> output.</p>    
<p></p></dd>
 
  <dt>gradient</dt>
<dd><p>Logical to indicate whether gradients are also 
    computed as well as the log density.</p></dd>
 
</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>Stan requires that parameters be defined along with their support.
  For example, for a variance parameter, we must define it 
  on the positive real line. But inside Stan's samplers all parameters
  defined on the constrained space are transformed to an unconstrained
  space amenable to Hamiltonian Monte Carlo. Because of this, Stan adjusts 
  the log density function by adding the log absolute value of the 
  Jacobian determinant. Once a new iteration is drawn, Stan transforms 
  the parameters back to the original constrained space without
  requiring interference from the user. However, when using the log 
  density function for a model exposed to R, we need to be careful.
  For example, if we are interested in finding the mode of parameters 
  on the constrained space, we then do not need the adjustment. 
  For this reason, the <code>log_prob</code> and <code>grad_log_prob</code> functions 
  accept an <code>adjust_transform</code> argument.</p>
    </div>
    <div id="value">
    <h2>Value</h2>
    <p></p>
<p><code>log_prob</code> returns a value (up to an additive constant) the log posterior. 
  If <code>gradient</code> is <code>TRUE</code>,  the gradients are also returned as an
  attribute with name <code>gradient</code>.</p>
<p></p>
<p><code>grad_log_prob</code> returns a vector of the gradients.  Additionally, the vector
  has an attribute named <code>log_prob</code> being the value the same as <code>log_prob</code></p>


<p>is called for the input parameters.</p>
<p></p>
<p><code>get_num_upars</code> returns the number of parameters on the unconstrained space.</p>
<p></p>
<p><code>constrain_pars</code> returns a list and <code>unconstrain_pars</code> returns a vector.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    <p>The Stan Development Team 
  <em>Stan Modeling Language User's Guide and Reference Manual</em>. 
  <a href="https://mc-stan.org" class="external-link">https://mc-stan.org</a>.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="stanfit-class.html">stanfit</a></code></p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="co"># see the examples in the help for stanfit as well</span></span></span>
<span class="r-in"><span><span class="co"># do a simple optimization problem </span></span></span>
<span class="r-in"><span><span class="va">opcode</span> <span class="op">&lt;-</span> <span class="st">"</span></span></span>
<span class="r-in"><span><span class="st">parameters {</span></span></span>
<span class="r-in"><span><span class="st">  real y;</span></span></span>
<span class="r-in"><span><span class="st">}</span></span></span>
<span class="r-in"><span><span class="st">model {</span></span></span>
<span class="r-in"><span><span class="st">  target += log(square(y - 5) + 1);</span></span></span>
<span class="r-in"><span><span class="st">}</span></span></span>
<span class="r-in"><span><span class="st">"</span></span></span>
<span class="r-in"><span><span class="va">opfit</span> <span class="op">&lt;-</span> <span class="fu"><a href="stan.html">stan</a></span><span class="op">(</span>model_code <span class="op">=</span> <span class="va">opcode</span>, chains <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">tfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="fu">log_prob</span><span class="op">(</span><span class="va">opfit</span>, <span class="va">y</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">tgrfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="fu">grad_log_prob</span><span class="op">(</span><span class="va">opfit</span>, <span class="va">y</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">or</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">tfun</span>, <span class="va">tgrfun</span>, method <span class="op">=</span> <span class="st">'BFGS'</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">or</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># return the gradient as an attribute</span></span></span>
<span class="r-in"><span><span class="va">tfun2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="op">{</span> </span></span>
<span class="r-in"><span>  <span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">grad_log_prob</span><span class="op">(</span><span class="va">opfit</span>, <span class="va">y</span><span class="op">)</span> </span></span>
<span class="r-in"><span>  <span class="va">lp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">g</span>, <span class="st">"log_prob"</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">lp</span>, <span class="st">"gradient"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">g</span></span></span>
<span class="r-in"><span>  <span class="va">lp</span></span></span>
<span class="r-in"><span><span class="op">}</span> </span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">or2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">nlm</a></span><span class="op">(</span><span class="va">tfun2</span>, <span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">or2</span> </span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Jiqiang Guo, Jonah Gabry, Ben Goodrich, Andrew Johnson, Sebastian Weber.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

